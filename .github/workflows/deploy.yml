# –ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ GitHub Actions.
name: CI/CD Pipeline

# –¢—Ä–∏–≥–≥–µ—Ä—ã: –ø–∞–π–ø–ª–∞–π–Ω —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main.
on:
  push:
    branches:
      - main

# –ó–∞–¥–∞—á–∏ (jobs), –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–∞–π–ø–ª–∞–π–Ω.
jobs:
  # –ó–∞–¥–∞—á–∞ –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ –¥–µ–ø–ª–æ—è.
  build-and-deploy:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é Ubuntu –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á.
    runs-on: ubuntu-latest

    # –®–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.
    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ –º–∞—à–∏–Ω—É GitHub Actions.
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Docker Build–∞x –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–Ω–æ–≥–æ–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã—Ö —Å–±–æ—Ä–æ–∫.
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Hub, –∏—Å–ø–æ–ª—å–∑—É—è —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ GitHub.
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º –æ–±—Ä–∞–∑ –¥–ª—è –±—ç–∫–µ–Ω–¥–∞.
      - name: Build and push backend (no cache)
        run: |
          docker build \
            --no-cache \
            --tag ${{ secrets.DOCKER_USERNAME }}/pet1-backend:latest \
            -f backend/Dockerfile backend
          docker push ${{ secrets.DOCKER_USERNAME }}/pet1-backend:latest


      # 5. –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º –æ–±—Ä–∞–∑ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞.
      - name: Build and push frontend (no cache)
        run: |
          docker build \
            --no-cache \
            --tag ${{ secrets.DOCKER_USERNAME }}/pet1-frontend:latest \
            --build-arg VITE_API_BASE_URL=http://backend:5000 \
            -f frontend/Dockerfile frontend
          docker push ${{ secrets.DOCKER_USERNAME }}/pet1-frontend:latest

      # 6. –î–µ–ø–ª–æ–∏–º –Ω–∞ –¥–æ–º–∞—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ SSH.
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USERNAME }}
          key: ${{ secrets.VPS_SSH_SECRET }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            cd ~/Repo/Pet_1
            git pull || true
            docker compose down || true
            docker network rm pet_1_petnet || true
            docker compose pull || true
            docker compose up -d --force-recreate || true

            # üõ† –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ default route –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
            sleep 2
            real_gw=$(ip route get 1.1.1.1 | awk '/via/ {print $3}')
            real_dev=$(ip route get 1.1.1.1 | awk '/dev/ {print $5}')
            sudo ip route del default || true
            sudo ip route add default via "$real_gw" dev "$real_dev"
